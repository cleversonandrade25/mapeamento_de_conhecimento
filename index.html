<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapeamento de Conhecimento - Seguran√ßa Metr√¥</title>
    <title>Avalia√ß√£o T√©cnica - Seguran√ßa Metr√¥</title>
    <style>
        :root {
            --primary: #003399; /* Azul Metr√¥ */
            --accent: #ffcc00; /* Amarelo Seguran√ßa */
            --bg: #f4f4f4;
            --white: #ffffff;
            --success: #28a745;
            --error: #dc3545;
        }

        body { 
@@ -25,18 +27,18 @@
        .container { 
            background: var(--white); 
            width: 90%; 
            max-width: 700px; 
            max-width: 800px; 
            padding: 40px; 
            border-radius: 12px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
            min-height: 400px;
            position: relative;
        }

        .slide { display: none; }
        .slide.active { display: flex; flex-direction: column; }

        h2 { color: var(--primary); margin-top: 0; }
        p { font-size: 18px; color: #333; line-height: 1.5; }
        .pergunta-texto { font-size: 20px; color: #222; font-weight: 500; margin-bottom: 25px; line-height: 1.4; }

        input { 
            padding: 15px; 
@@ -45,12 +47,14 @@
            border: 2px solid #ddd; 
            border-radius: 8px; 
            outline: none;
            width: 100%;
            box-sizing: border-box;
        }

        input:focus { border-color: var(--primary); }

        .btn-principal { 
            padding: 15px 30px; 
            padding: 18px 30px; 
            background: var(--primary); 
            color: white; 
            border: none; 
@@ -59,19 +63,23 @@
            font-weight: bold; 
            font-size: 18px; 
            margin-top: 20px; 
            transition: transform 0.2s;
        }

        .options-container { display: grid; gap: 12px; margin-top: 20px; }
        .btn-principal:active { transform: scale(0.98); }

        .options-container { display: grid; gap: 12px; margin-top: 10px; }

        .opt-btn { 
            padding: 15px; 
            padding: 16px; 
            border: 2px solid #eee; 
            border-radius: 8px; 
            cursor: pointer; 
            text-align: left; 
            transition: 0.3s; 
            transition: all 0.2s; 
            background: var(--white);
            font-size: 16px;
            color: #444;
        }

        .opt-btn:hover { 
@@ -81,11 +89,12 @@

        /* Barra de Progresso */
        .progress-container { margin-bottom: 30px; }
        .progress-bar { height: 8px; background: #eee; border-radius: 4px; overflow: hidden; }
        .progress-bar { height: 10px; background: #eee; border-radius: 5px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--accent); width: 0%; transition: 0.4s; }
        .status-text { font-size: 12px; color: #666; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; display: block; }
        .status-text { font-size: 13px; color: #666; font-weight: bold; margin-bottom: 8px; display: block; }

        #loading { display: none; margin-top: 20px; color: var(--primary); font-weight: bold; text-align: center; }
        #loading { display: none; margin-top: 20px; text-align: center; font-weight: bold; color: var(--primary); }
        .nota-final { font-size: 48px; color: var(--primary); margin: 20px 0; }
    </style>
</head>
<body>
@@ -100,27 +109,30 @@

    <div id="slide-login" class="slide active">
        <h2>Mapeamento de Conhecimento</h2>
        <p>Preencha seus dados para iniciar a avalia√ß√£o t√©cnica de seguran√ßa.</p>
        <p>Inicie sua avalia√ß√£o t√©cnica de seguran√ßa operacional. S√£o 10 quest√µes aleat√≥rias.</p>
        <input type="text" id="nome" placeholder="Nome Completo">
        <input type="text" id="re" placeholder="Registro Operacional (RE)">
        <button class="btn-principal" onclick="carregarEIniciar()">Iniciar Teste</button>
        <button class="btn-principal" onclick="carregarEIniciar()">Iniciar Avalia√ß√£o</button>
    </div>

    <div id="slide-quiz" class="slide">
        <small id="assunto-tag" style="color: var(--primary); font-weight: bold;"></small>
        <p id="pergunta-texto"></p>
        <small id="assunto-tag" style="color: var(--primary); font-weight: bold; text-transform: uppercase;"></small>
        <div id="pergunta-texto" class="pergunta-texto"></div>
        <div id="opcoes" class="options-container"></div>
    </div>

    <div id="slide-final" class="slide" style="text-align: center;">
        <h2 id="titulo-final">Processando...</h2>
        <p id="msg-final">Aguarde enquanto salvamos suas respostas na Planilha OPS.</p>
        <div id="loading">üì§ Enviando dados...</div>
        <div id="resultado-container" style="display: none;">
            <div class="nota-final"><span id="nota-valor">0</span>/10</div>
            <p id="msg-final">Salvando seus resultados na base de dados...</p>
        </div>
        <div id="loading">üì§ Sincronizando com a Planilha OPS...</div>
    </div>
</div>

<script>
    // CONFIGURA√á√ÉO
    // --- CONFIGURA√á√ÉO ---
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzSkw03HQEPcgEVEF_gsnu30z2MpbcJH_pONLecrn09PtVapaBWTobqrUEBelVo4UnH/exec";

    let bancoCompleto = [];
@@ -130,55 +142,50 @@ <h2 id="titulo-final">Processando...</h2>
    let resultados = {
        nome: "",
        re: "",
        respostas: [],
        tempos: []
        respostasDetalhas: [] // Armazenar√° {pergunta, escolha, status, tempo}
    };

    async function carregarEIniciar() {
        const nome = document.getElementById('nome').value;
        const re = document.getElementById('re').value;
        const nome = document.getElementById('nome').value.trim();
        const re = document.getElementById('re').value.trim();

        if (!nome || !re) {
            alert("Por favor, preencha o Nome e o RE antes de iniciar.");
            alert("Por favor, informe seu Nome e RE.");
            return;
        }

        resultados.nome = nome;
        resultados.re = re;

        try {
            // Fetch com Cache Buster para evitar ler arquivos antigos
            const response = await fetch('perguntas.json?nocache=' + Date.now());
            if (!response.ok) throw new Error("Erro ao carregar perguntas.json");
            const response = await fetch('perguntas.json?v=' + Date.now());
            if (!response.ok) throw new Error("Erro ao carregar banco de dados JSON.");

            bancoCompleto = await response.json();

            // Sorteia 10 quest√µes aleat√≥rias do banco de 20
            // Sorteia 10 quest√µes de forma aleat√≥ria
            questonarioAtivo = bancoCompleto.sort(() => 0.5 - Math.random()).slice(0, 10);

            // Troca de tela
            document.getElementById('slide-login').classList.remove('active');
            document.getElementById('ui-progress').style.display = 'block';

            exibirQuestao();
        } catch (error) {
            console.error(error);
            alert("Falha t√©cnica: O arquivo 'perguntas.json' n√£o foi encontrado ou est√° mal formatado.");
            alert("Erro cr√≠tico: Verifique se o arquivo perguntas.json est√° no GitHub e se a sintaxe est√° correta.");
        }
    }

    function exibirQuestao() {
        const q = questonarioAtivo[indiceAtual];
        const containerOpcoes = document.getElementById('opcoes');

        // Atualiza UI
        document.getElementById('slide-quiz').classList.add('active');
        document.getElementById('assunto-tag').innerText = `[ ${q.assunto} ]`;
        document.getElementById('assunto-tag').innerText = q.assunto;
        document.getElementById('pergunta-texto').innerText = q.pergunta;
        document.getElementById('label-progresso').innerText = `Quest√£o ${indiceAtual + 1} de 10`;
        document.getElementById('fill').style.width = `${(indiceAtual + 1) * 10}%`;

        // Limpa e gera op√ß√µes
        containerOpcoes.innerHTML = "";
        q.alternativas.forEach(alt => {
            const btn = document.createElement('button');
@@ -193,47 +200,62 @@ <h2 id="titulo-final">Processando...</h2>

    function processarResposta(escolha) {
        const tempoGasto = (Date.now() - tempoInicioQuestao) / 1000;
        const qAtual = questonarioAtivo[indiceAtual];

        resultados.respostas.push(escolha);
        resultados.tempos.push(tempoGasto.toFixed(2));
        // Valida√ß√£o: Letra inicial (A, B, C ou D)
        const letraEscolhida = escolha.substring(0, 1).toUpperCase();
        const estaCorreta = (letraEscolhida === qAtual.correta.toUpperCase()) ? "SIM" : "N√ÉO";

        // Registra o objeto completo da resposta
        resultados.respostasDetalhas.push({
            pergunta: qAtual.pergunta,
            escolha: escolha,
            status: estaCorreta,
            tempo: tempoGasto.toFixed(2)
        });

        indiceAtual++;

        if (indiceAtual < 10) {
            exibirQuestao();
        } else {
            finalizarAvaliacao();
            enviarRelatorioFinal();
        }
    }

    function finalizarAvaliacao() {
    function enviarRelatorioFinal() {
        document.getElementById('slide-quiz').classList.remove('active');
        document.getElementById('ui-progress').style.display = 'none';
        document.getElementById('slide-final').classList.add('active');
        document.getElementById('loading').style.display = 'block';

        const tempoTotal = resultados.tempos.reduce((a, b) => parseFloat(a) + parseFloat(b), 0).toFixed(2);
        const acertos = resultados.respostasDetalhas.filter(r => r.status === "SIM").length;
        const tempoTotal = resultados.respostasDetalhas.reduce((acc, curr) => acc + parseFloat(curr.tempo), 0).toFixed(2);

        const dadosParaEnviar = {
        // Objeto de dados estruturado para a nova l√≥gica da planilha
        const payload = {
            nome: resultados.nome,
            re: resultados.re,
            respostas: resultados.respostas,
            tempos: resultados.tempos,
            tempo_total: tempoTotal
            nota: acertos,
            tempo_total: tempoTotal,
            detalhes: resultados.respostasDetalhas // Enviando o trio Pergunta/Resposta/Status
        };

        fetch(SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors', // Necess√°rio para o Google Apps Script
            mode: 'no-cors',
            cache: 'no-cache',
            body: JSON.stringify(dadosParaEnviar)
            body: JSON.stringify(payload)
        }).then(() => {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('titulo-final').innerText = "‚úÖ Enviado!";
            document.getElementById('msg-final').innerText = "Obrigado, agente. Seus dados foram computados com sucesso.";
            document.getElementById('resultado-container').style.display = 'block';
            document.getElementById('titulo-final').innerText = "Avalia√ß√£o Conclu√≠da";
            document.getElementById('nota-valor').innerText = acertos;
            document.getElementById('msg-final').innerHTML = "Dados sincronizados com sucesso!<br>Obrigado pela participa√ß√£o.";
        }).catch(err => {
            console.error("Erro no envio:", err);
            console.error("Erro no fetch:", err);
            document.getElementById('loading').style.display = 'none';
            document.getElementById('msg-final').innerText = "Erro ao conectar com a planilha. Verifique sua conex√£o.";
            document.getElementById('msg-final').innerText = "Erro ao salvar na planilha. Avise o administrador.";
        });
    }
</script>
