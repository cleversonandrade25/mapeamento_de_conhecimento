<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapeamento de Conhecimento - Segurança</title>
    <style>
        :root { --primary: #003399; --accent: #ffcc00; }
        body { font-family: 'Segoe UI', sans-serif; background: #f4f4f4; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .container { background: white; width: 90%; max-width: 800px; padding: 40px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .slide { display: none; }
        .active { display: block; }
        .opt-btn { display: block; width: 100%; padding: 15px; margin: 10px 0; border: 2px solid #eee; border-radius: 8px; cursor: pointer; text-align: left; background: white; font-size: 16px; }
        .opt-btn:hover { border-color: var(--primary); background: #f0f7ff; }
        .progress-bar { height: 10px; background: #eee; border-radius: 5px; margin-bottom: 20px; }
        .progress-fill { height: 100%; background: var(--accent); width: 0%; border-radius: 5px; transition: 0.3s; }
        #loading { display: none; font-weight: bold; color: var(--primary); }
    </style>
</head>
<body>

<div class="container">
    <div id="progresso-container" style="display:none;">
        <div class="progress-bar"><div id="fill" class="progress-fill"></div></div>
        <small id="status-pergunta"></small>
    </div>

    <div id="slide-login" class="slide active">
        <h2>Avaliação de Segurança Operacional</h2>
        <input type="text" id="nome" placeholder="Nome Completo" style="width:95%; padding:12px; margin-bottom:10px;">
        <input type="text" id="re" placeholder="RE" style="width:95%; padding:12px; margin-bottom:20px;">
        <button onclick="carregarEIniciar()" style="padding:15px 30px; background:var(--primary); color:white; border:none; border-radius:6px; cursor:pointer;">Iniciar Teste (10 questões)</button>
    </div>

    <div id="slide-quiz" class="slide">
        <small id="assunto-tag" style="color: grey; text-transform: uppercase;"></small>
        <h3 id="pergunta-texto"></h3>
        <div id="opcoes"></div>
    </div>

    <div id="slide-final" class="slide">
        <h2>Concluído!</h2>
        <p id="feedback">Enviando resultados...</p>
        <div id="loading">Processando...</div>
    </div>
</div>

<script>
    const SCRIPT_URL = "SEU_LINK_DO_GOOGLE_SCRIPT_AQUI";
    let bancoQuestoes = [];
    let questoesSorteadas = [];
    let indiceAtual = 0;
    let tempoInicio;
    let resultados = { nome: "", re: "", respostas: [], tempos: [] };

    async function carregarEIniciar() {
        const nome = document.getElementById('nome').value;
        const re = document.getElementById('re').value;
        if(!nome || !re) return alert("Preencha seus dados!");

        resultados.nome = nome;
        resultados.re = re;

        try {
            const response = await fetch('perguntas.json');
            bancoQuestoes = await response.json();
            
            // Embaralha e pega 10
            questoesSorteadas = bancoQuestoes.sort(() => 0.5 - Math.random()).slice(0, 10);
            
            document.getElementById('slide-login').classList.remove('active');
            document.getElementById('progresso-container').style.display = 'block';
            mostrarQuestao();
        } catch (e) {
            alert("Erro ao carregar banco de perguntas.");
        }
    }

    function mostrarQuestao() {
        const q = questoesSorteadas[indiceAtual];
        document.getElementById('slide-quiz').classList.add('active');
        document.getElementById('assunto-tag').innerText = q.assunto;
        document.getElementById('pergunta-texto').innerText = q.pergunta;
        document.getElementById('status-pergunta').innerText = `Questão ${indiceAtual + 1} de 10`;
        document.getElementById('fill').style.width = `${(indiceAtual + 1) * 10}%`;
        
        const opcoesDiv = document.getElementById('opcoes');
        opcoesDiv.innerHTML = "";
        q.alternativas.forEach(alt => {
            const btn = document.createElement('button');
            btn.className = 'opt-btn';
            btn.innerText = alt;
            btn.onclick = () => registrarResposta(alt);
            opcoesDiv.appendChild(btn);
        });
        
        tempoInicio = Date.now();
    }

    function registrarResposta(escolha) {
        const tempoGasto = (Date.now() - tempoInicio) / 1000;
        resultados.respostas.push(escolha);
        resultados.tempos.push(tempoGasto.toFixed(2));

        indiceAtual++;
        if(indiceAtual < 10 && indiceAtual < questoesSorteadas.length) {
            mostrarQuestao();
        } else {
            enviarDados();
        }
    }

    function enviarDados() {
    document.getElementById('slide-quiz').classList.remove('active');
    document.getElementById('slide-final').classList.add('active');
    document.getElementById('loading').style.display = 'block';

    const tempoTotal = resultados.tempos.reduce((a, b) => parseFloat(a) + parseFloat(b), 0).toFixed(2);

    const payload = {
        nome: resultados.nome,
        re: resultados.re,
        respostas: resultados.respostas, // Envia a lista [A, B, C...]
        tempos: resultados.tempos,       // Envia a lista [10.5, 5.2...]
        tempo_total: tempoTotal
    };

    fetch(SCRIPT_URL, {
        method: 'POST',
        mode: 'no-cors',
        body: JSON.stringify(payload)
    }).then(() => {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('feedback').innerText = "Avaliação enviada com sucesso!";
    }).catch(err => {
        console.error(err);
        document.getElementById('feedback').innerText = "Erro ao enviar. Comunique ao supervisor.";
    });
}
</script>
</body>
</html>