<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Avaliação Técnica - Segurança</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="container">
    <div id="ui-progress" style="display: none;">
        <div class="progress-bar"><div id="fill" class="progress-fill"></div></div>
    </div>

    <div id="slide-login" class="slide active">
        <h2>Acesso ao Mapeamento</h2>
        <input type="text" id="nome" placeholder="Nome Completo" style="padding:15px; margin-bottom:10px; border-radius:8px; border:1px solid #ddd;">
        <input type="text" id="re" placeholder="RE" style="padding:15px; margin-bottom:10px; border-radius:8px; border:1px solid #ddd;">
        <button class="btn-principal" onclick="iniciarQuiz()">Iniciar</button>
    </div>

    <div id="slide-quiz" class="slide">
        <h3 id="pergunta-texto"></h3>
        <div id="opcoes"></div>
    </div>

    <div id="slide-final" class="slide">
        <h2>Enviando resultados...</h2>
        <p id="feedback-final">Por favor, não feche a página.</p>
    </div>
</div>

<script src="spreadsheet-engine.js"></script>
<script>
    let banco = [];
    let selecionadas = [];
    let atual = 0;
    let tempoInicio;
    let respostasParaExportar = [];

    async function iniciarQuiz() {
        const res = await fetch('perguntas.json');
        banco = await res.json();
        selecionadas = banco.sort(() => 0.5 - Math.random()).slice(0, 10);
        
        document.getElementById('slide-login').classList.remove('active');
        document.getElementById('ui-progress').style.display = 'block';
        mostrarQuestao();
    }

    function mostrarQuestao() {
        const q = selecionadas[atual];
        document.getElementById('slide-quiz').classList.add('active');
        document.getElementById('pergunta-texto').innerText = q.pergunta;
        document.getElementById('fill').style.width = `${(atual + 1) * 10}%`;
        
        const lista = document.getElementById('opcoes');
        lista.innerHTML = "";
        q.alternativas.forEach(alt => {
            const btn = document.createElement('button');
            btn.className = 'opt-btn';
            btn.innerText = alt;
            btn.onclick = () => salvarResposta(alt);
            lista.appendChild(btn);
        });
        tempoInicio = Date.now();
    }

    function salvarResposta(escolha) {
        const tempo = ((Date.now() - tempoInicio) / 1000).toFixed(2);
        const q = selecionadas[atual];
        const status = escolha.startsWith(q.correta) ? "SIM" : "NÃO";

        respostasParaExportar.push({ pergunta: q.pergunta, escolha: escolha, status: status, tempo: tempo });

        atual++;
        if (atual < 10) mostrarQuestao();
        else finalizar();
    }

    function finalizar() {
        document.getElementById('slide-quiz').classList.remove('active');
        document.getElementById('slide-final').classList.add('active');
        
        const dadosUsuario = { 
            nome: document.getElementById('nome').value, 
            re: document.getElementById('re').value 
        };

        // CHAMA A FUNÇÃO QUE ESTÁ NO OUTRO ARQUIVO JS
        prepararEEnviar(dadosUsuario, respostasParaExportar).then(() => {
            document.getElementById('feedback-final').innerText = "✅ Sucesso! Dados salvos na Planilha.";
        });
    }
</script>
</body>
</html>
