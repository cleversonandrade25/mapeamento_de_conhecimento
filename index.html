<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapeamento de Conhecimento - Seguran√ßa Metr√¥</title>
    <style>
        :root {
            --primary: #003399; /* Azul Metr√¥ */
            --accent: #ffcc00; /* Amarelo Seguran√ßa */
            --bg: #f4f4f4;
            --white: #ffffff;
        }

        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: var(--bg); 
            margin: 0; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
        }

        .container { 
            background: var(--white); 
            width: 90%; 
            max-width: 700px; 
            padding: 40px; 
            border-radius: 12px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
            min-height: 400px;
        }

        .slide { display: none; }
        .slide.active { display: flex; flex-direction: column; }

        h2 { color: var(--primary); margin-top: 0; }
        p { font-size: 18px; color: #333; line-height: 1.5; }

        input { 
            padding: 15px; 
            font-size: 16px; 
            margin: 10px 0; 
            border: 2px solid #ddd; 
            border-radius: 8px; 
            outline: none;
        }

        input:focus { border-color: var(--primary); }

        .btn-principal { 
            padding: 15px 30px; 
            background: var(--primary); 
            color: white; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: bold; 
            font-size: 18px; 
            margin-top: 20px; 
        }

        .options-container { display: grid; gap: 12px; margin-top: 20px; }

        .opt-btn { 
            padding: 15px; 
            border: 2px solid #eee; 
            border-radius: 8px; 
            cursor: pointer; 
            text-align: left; 
            transition: 0.3s; 
            background: var(--white);
            font-size: 16px;
        }

        .opt-btn:hover { 
            border-color: var(--primary); 
            background: #f0f7ff; 
        }

        /* Barra de Progresso */
        .progress-container { margin-bottom: 30px; }
        .progress-bar { height: 8px; background: #eee; border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--accent); width: 0%; transition: 0.4s; }
        .status-text { font-size: 12px; color: #666; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; display: block; }

        #loading { display: none; margin-top: 20px; color: var(--primary); font-weight: bold; text-align: center; }
    </style>
</head>
<body>

<div class="container">
    <div id="ui-progress" class="progress-container" style="display: none;">
        <span class="status-text" id="label-progresso">Quest√£o 1 de 10</span>
        <div class="progress-bar">
            <div id="fill" class="progress-fill"></div>
        </div>
    </div>

    <div id="slide-login" class="slide active">
        <h2>Mapeamento de Conhecimento</h2>
        <p>Preencha seus dados para iniciar a avalia√ß√£o t√©cnica de seguran√ßa.</p>
        <input type="text" id="nome" placeholder="Nome Completo">
        <input type="text" id="re" placeholder="Registro Operacional (RE)">
        <button class="btn-principal" onclick="carregarEIniciar()">Iniciar Teste</button>
    </div>

    <div id="slide-quiz" class="slide">
        <small id="assunto-tag" style="color: var(--primary); font-weight: bold;"></small>
        <p id="pergunta-texto"></p>
        <div id="opcoes" class="options-container"></div>
    </div>

    <div id="slide-final" class="slide" style="text-align: center;">
        <h2 id="titulo-final">Processando...</h2>
        <p id="msg-final">Aguarde enquanto salvamos suas respostas na Planilha OPS.</p>
        <div id="loading">üì§ Enviando dados...</div>
    </div>
</div>

<script>
    // CONFIGURA√á√ÉO
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzSkw03HQEPcgEVEF_gsnu30z2MpbcJH_pONLecrn09PtVapaBWTobqrUEBelVo4UnH/exec";
    
    let bancoCompleto = [];
    let questonarioAtivo = [];
    let indiceAtual = 0;
    let tempoInicioQuestao;
    let resultados = {
        nome: "",
        re: "",
        respostas: [],
        tempos: []
    };

    async function carregarEIniciar() {
        const nome = document.getElementById('nome').value;
        const re = document.getElementById('re').value;

        if (!nome || !re) {
            alert("Por favor, preencha o Nome e o RE antes de iniciar.");
            return;
        }

        resultados.nome = nome;
        resultados.re = re;

        try {
            // Fetch com Cache Buster para evitar ler arquivos antigos
            const response = await fetch('perguntas.json?nocache=' + Date.now());
            if (!response.ok) throw new Error("Erro ao carregar perguntas.json");
            
            bancoCompleto = await response.json();
            
            // Sorteia 10 quest√µes aleat√≥rias do banco de 20
            questonarioAtivo = bancoCompleto.sort(() => 0.5 - Math.random()).slice(0, 10);

            // Troca de tela
            document.getElementById('slide-login').classList.remove('active');
            document.getElementById('ui-progress').style.display = 'block';
            
            exibirQuestao();
        } catch (error) {
            console.error(error);
            alert("Falha t√©cnica: O arquivo 'perguntas.json' n√£o foi encontrado ou est√° mal formatado.");
        }
    }

    function exibirQuestao() {
        const q = questonarioAtivo[indiceAtual];
        const containerOpcoes = document.getElementById('opcoes');
        
        // Atualiza UI
        document.getElementById('slide-quiz').classList.add('active');
        document.getElementById('assunto-tag').innerText = `[ ${q.assunto} ]`;
        document.getElementById('pergunta-texto').innerText = q.pergunta;
        document.getElementById('label-progresso').innerText = `Quest√£o ${indiceAtual + 1} de 10`;
        document.getElementById('fill').style.width = `${(indiceAtual + 1) * 10}%`;

        // Limpa e gera op√ß√µes
        containerOpcoes.innerHTML = "";
        q.alternativas.forEach(alt => {
            const btn = document.createElement('button');
            btn.className = 'opt-btn';
            btn.innerText = alt;
            btn.onclick = () => processarResposta(alt);
            containerOpcoes.appendChild(btn);
        });

        tempoInicioQuestao = Date.now();
    }

    function processarResposta(escolha) {
        const tempoGasto = (Date.now() - tempoInicioQuestao) / 1000;
        
        resultados.respostas.push(escolha);
        resultados.tempos.push(tempoGasto.toFixed(2));

        indiceAtual++;

        if (indiceAtual < 10) {
            exibirQuestao();
        } else {
            finalizarAvaliacao();
        }
    }

    function finalizarAvaliacao() {
        document.getElementById('slide-quiz').classList.remove('active');
        document.getElementById('slide-final').classList.add('active');
        document.getElementById('loading').style.display = 'block';

        const tempoTotal = resultados.tempos.reduce((a, b) => parseFloat(a) + parseFloat(b), 0).toFixed(2);

        const dadosParaEnviar = {
            nome: resultados.nome,
            re: resultados.re,
            respostas: resultados.respostas,
            tempos: resultados.tempos,
            tempo_total: tempoTotal
        };

        fetch(SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors', // Necess√°rio para o Google Apps Script
            cache: 'no-cache',
            body: JSON.stringify(dadosParaEnviar)
        }).then(() => {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('titulo-final').innerText = "‚úÖ Enviado!";
            document.getElementById('msg-final').innerText = "Obrigado, agente. Seus dados foram computados com sucesso.";
        }).catch(err => {
            console.error("Erro no envio:", err);
            document.getElementById('loading').style.display = 'none';
            document.getElementById('msg-final').innerText = "Erro ao conectar com a planilha. Verifique sua conex√£o.";
        });
    }
</script>

</body>
</html>
